{{- if (.Values.aggregator).enabled }}

apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ include "kubecost.aggregator.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "kubecost.aggregator.commonLabels" . | nindent 4 }}
    {{- with .Values.global.additionalLabels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  annotations:
  {{- with .Values.global.annotations }}
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- with .Values.aggregator.annotations }}
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  replicas: {{ .Values.aggregator.replicas }}
  serviceName: {{ template "kubecost.aggregator.serviceName" . }}
  selector:
    matchLabels:
    {{- include "kubecost.aggregator.selectorLabels" . | nindent 6 }}
  volumeClaimTemplates:
  - metadata:
      name: aggregator-db-storage
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: {{ .Values.aggregator.aggregatorDbStorage.storageClass }}
      resources:
        requests:
          storage:  {{ .Values.aggregator.aggregatorDbStorage.storageRequest }}
  - metadata:
      # In the StatefulSet config, Aggregator should not share any filesystem
      # state with the cost-model to maintain independence and improve
      # stability (in the event of bad file-locking state). Still, there is
      # a need to "mount" ConfigMap files (using the watcher) to a file system;
      # that's what this per-replica Volume is used for.
      name: persistent-configs
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: {{ .Values.aggregator.persistentConfigsStorage.storageClass }}
      resources:
        requests:
          storage: {{ .Values.aggregator.persistentConfigsStorage.storageRequest }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: aggregator
        app.kubernetes.io/instance: {{ .Release.Name }}
        app: aggregator
        {{- with .Values.global.additionalLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      annotations:
        {{- with .Values.global.podAnnotations}}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        checksum/configs: {{ include "kubecost.configsChecksum" . }}
    spec:
      restartPolicy: Always
    {{- if .Values.aggregator.securityContext }}
      securityContext:
    {{- toYaml .Values.aggregator.securityContext | nindent 8 }}
    {{- else if and (.Values.global.platforms.openshift.enabled) (.Values.global.platforms.openshift.securityContext) }}
      securityContext:
    {{- toYaml .Values.global.platforms.openshift.securityContext | nindent 8 }}
    {{- else if .Values.global.securityContext }}
      securityContext:
    {{- toYaml .Values.global.securityContext | nindent 8 }}
    {{- end }}
      serviceAccountName: {{ template "kubecost.aggregator.serviceAccountName" . }}
      volumes:
        - name: aggregator-staging
          emptyDir:
            sizeLimit: {{ .Values.aggregator.stagingEmptyDirSizeLimit }}
        - name: user-helm-values
          configMap:
            name: {{ include "kubecost.aggregator.cm.helmvalues.name" . }}
        - name: federated-storage-config
          secret:
            defaultMode: 420
            secretName: {{ include "kubecost.federatedStorage.secretName" . }}
        {{- if ((.Values.kubecostProductConfigs).productKey).enabled }}
        - name: productkey-secret
          secret:
            secretName: {{ include "kubecost.productKey.secretName" . }}
            items:
            - key: productkey.json
              path: productkey.json
        {{- end }}
        {{- if or ((.Values.kubecostProductConfigs).smtp).secretname ((.Values.kubecostProductConfigs).smtp).config }}
        - name: smtp-secret
          secret:
            secretName: {{ include "kubecost.smtp.secretName" . }}
            items:
            - key: smtp.json
              path: smtp.json
        {{- end }}
        {{- if (.Values.saml).enabled }}
        {{- if .Values.saml.secretName }}
        - name: secret-volume
          secret:
            secretName: {{ .Values.saml.secretName }}
        {{- end }}
        {{- if .Values.saml.encryptionCertSecret }}
        - name: saml-encryption-cert
          secret:
            secretName: {{ .Values.saml.encryptionCertSecret }}
        {{- end }}
        {{- if .Values.saml.decryptionKeySecret }}
        - name: saml-decryption-key
          secret:
            secretName: {{ .Values.saml.decryptionKeySecret }}
        {{- end }}
        {{- if .Values.saml.metadataSecretName }}
        - name: metadata-secret-volume
          secret:
            secretName: {{ .Values.saml.metadataSecretName }}
        {{- end }}
        - name: saml-auth-secret
          secret:
            secretName: {{ .Values.saml.authSecretName | default "kubecost-saml-secret" }}
        {{- if .Values.saml.rbac.enabled }}
        - name: saml-roles
          configMap:
            name: {{ template "kubecost.fullname" . }}-saml
        {{- end }}
        {{- if eq (include "kubecost.authMasterKey.enabled" .) "true" }}
        - name: kubecost-master-api-key
          secret:
            secretName: {{ .Values.saml.apiMasterKeySecret | default "kubecost-master-api-key" }}
        {{- end }}
        {{- end }}
        {{- if .Values.oidc }}
        {{- if .Values.oidc.enabled }}
        - name: oidc-config
          configMap:
            name: {{ template "kubecost.fullname" . }}-oidc
        {{- if and (not .Values.oidc.existingCustomSecret.enabled) .Values.oidc.secretName }}
        - name: oidc-client-secret
          secret:
            secretName: {{ .Values.oidc.secretName }}
        {{- end }}
        {{- if .Values.oidc.existingCustomSecret.enabled }}
        - name: oidc-client-secret
          secret:
            secretName: {{ .Values.oidc.existingCustomSecret.name }}
        {{- end }}
        {{- if eq (include "kubecost.authMasterKey.enabled" .) "true" }}
        - name: kubecost-master-api-key
          secret:
            secretName: {{ .Values.oidc.apiMasterKeySecret | default "kubecost-master-api-key" }}
        {{- end }}
        {{- end }}
        {{- end }}
        {{- if eq (include "kubecost.rbacTeams.enabled" .) "true" }}
        - name: kubecost-rbac-secret
          secret:
            secretName: kubecost-rbac-secret
        {{- end }}
        {{- if eq (include "kubecost.rbacTeams.config.enabled" .) "true" }}
        - name: kubecost-rbac-teams-config
          configMap:
        {{- if .Values.teams.teamsConfigMapName }}
            name: {{ .Values.teams.teamsConfigMapName }}
        {{- else }}
            name: kubecost-rbac-teams-config
        {{- end }}
        {{- end }}
        {{- if .Values.global.integrations.postgres.enabled }}
        - name: postgres-creds
          secret:
            {{- if not (eq .Values.global.integrations.postgres.databaseSecretName "") }}
            secretName: {{ .Values.global.integrations.postgres.databaseSecretName }}
            {{- else }}
            secretName: kubecost-integrations-postgres
            {{- end }}
        - name: postgres-queries
          configMap:
            name: kubecost-integrations-postgres-queries
        {{- end }}
        {{- if .Values.global.integrations.turbonomic.enabled }}
        - name: turbonomic-credentials
          secret:
            secretName: kubecost-integrations-turbonomic
        {{- end }}
        {{- if .Values.global.updateCaTrust.enabled }}
        - name: ca-certs-secret
          {{- if .Values.global.updateCaTrust.caCertsSecret }}
          secret:
            defaultMode: 420
            secretName: {{ .Values.global.updateCaTrust.caCertsSecret }}
          {{- else }}
          configMap:
            name: {{ .Values.global.updateCaTrust.caCertsConfig }}
          {{- end }}
        - name: ssl-path
          emptyDir: {}
        {{- end }}
        {{- if (.Values.enterpriseCustomPricing).enabled }}
        - name: kubecost-enterprise-pricing
          configMap:
            name: {{ .Values.enterpriseCustomPricing.configMapName }}
        {{- end }}
        {{- if ((.Values.kubecostProductConfigs).actions).config }}
        - name: actions-config
          configMap:
            name: {{ include "kubecost.actions.configMapName" . }}
        {{- end }}
      {{- if ((.Values.kubecostProductConfigs).actions).enabled }}
        {{- if and (not (((.Values.kubecostProductConfigs).actions).storageConfigSecret)) (not (((.Values.kubecostProductConfigs).actions).storageConfig)) }}
        - name: actions-storage
          emptyDir: {}
        {{- end }}
        {{- if ((.Values.kubecostProductConfigs).actions).storageConfig }}
        - name: actions-storage-config
          secret:
            defaultMode: 420
            secretName: {{ include "kubecost.actions.secretName" . }}
        {{- end }}
        {{- if ((.Values.kubecostProductConfigs).actions).storageConfigSecret }}
          {{- if eq ((.Values.kubecostProductConfigs).actions).storageConfigSecret (include "kubecost.federatedStorage.secretName" .) }}
        - name: actions-storage
          emptyDir: {}
          {{- else }}
        - name: actions-storage-config
          secret:
            defaultMode: 420
            secretName: {{ include "kubecost.actions.secretName" . }}
          {{- end }}
        {{- end }}
        {{- if  ((.Values.kubecostProductConfigs).actions).turndownClusters }}
        - name: kubecost-clusters
          configMap:
            name: kubecost-clusters
        {{- end }}
      {{- end }}
        {{- if .Values.aggregator.extraVolumes }}
        {{- toYaml .Values.aggregator.extraVolumes | nindent 8 }}
        {{- end }}
      initContainers:
      {{- if .Values.global.updateCaTrust.enabled }}
        - name: update-ca-trust
          image: {{ include "kubecost.aggregator.image" . }}
          {{- if .Values.aggregator.imagePullPolicy }}
          imagePullPolicy: {{ .Values.aggregator.imagePullPolicy }}
          {{- else }}
          imagePullPolicy: Always
          {{- end }}
          {{- with .Values.global.updateCaTrust.securityContext }}
          securityContext: {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.global.updateCaTrust.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          command:
            - 'sh'
            - '-c'
            - >
              mkdir -p /etc/pki/ca-trust/extracted/{edk2,java,openssl,pem};
              /usr/bin/update-ca-trust extract;
          volumeMounts:
            - name: ca-certs-secret
              mountPath: {{ .Values.global.updateCaTrust.caCertsMountPath | quote }}
            - name: ssl-path
              mountPath: "/etc/pki/ca-trust/extracted"
              readOnly: false
        {{- end}}
      containers:
        - name: aggregator
        {{- if .Values.aggregator.containerSecurityContext }}
          securityContext:
            {{- toYaml .Values.aggregator.containerSecurityContext | nindent 12 }}
        {{- else if .Values.global.containerSecurityContext }}
          securityContext:
            {{- toYaml .Values.global.containerSecurityContext | nindent 12 }}
        {{- end }}
          image: {{ include "kubecost.aggregator.image" . }}
          {{- if .Values.aggregator.readinessProbe.enabled }}
          readinessProbe:
            httpGet:
              path: /healthz
              port: 9004
            initialDelaySeconds: {{ .Values.aggregator.readinessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.aggregator.readinessProbe.periodSeconds }}
            failureThreshold: {{ .Values.aggregator.readinessProbe.failureThreshold }}
          {{- end }}
          {{- if .Values.aggregator.imagePullPolicy }}
          imagePullPolicy: {{ .Values.aggregator.imagePullPolicy }}
          {{- else }}
          imagePullPolicy: Always
          {{- end }}
          args: [ "waterfowl" ]
          ports:
            - name: tcp-api
              containerPort: 9004
              protocol: TCP
            - name: db-metrics
              containerPort: 9363
              protocol: TCP
          {{- with.Values.aggregator.extraContainerPorts }}
            {{- toYaml . | nindent 12 }}
          {{- end }}
          resources:
            {{- toYaml .Values.aggregator.resources | nindent 12 }}
          volumeMounts:
            - name: persistent-configs
              mountPath: /var/configs
            - name: user-helm-values
              mountPath: /var/configs/values
            - name: federated-storage-config
              mountPath: /var/configs/federated-store.yaml
              subPath: {{ include "kubecost.federatedStorage.fileName" . }}
              readOnly: true
            - name: aggregator-db-storage
              mountPath: /var/configs/waterfowl/duckdb
            - name: aggregator-staging
              mountPath: /var/configs/waterfowl
              {{- if (not .Values.aggregator.legacyMode ) }}
            - name: aggregator-db-storage
              mountPath: /var/lib/clickhouse
              {{- end }}
            {{- if ((.Values.kubecostProductConfigs).productKey).enabled }}
            - name: productkey-secret
              mountPath: /var/configs/productkey
            {{- end }}
            {{- if ((.Values.kubecostProductConfigs).smtp).secretname }}
            - name: smtp-secret
              mountPath: /var/configs/smtp
            {{- end }}
            {{- if (.Values.saml).enabled }}
            {{- if (.Values.saml).secretName }}
            - name: secret-volume
              mountPath: /var/configs/secret-volume
            {{- end }}
            {{- if (.Values.saml).encryptionCertSecret }}
            - name: saml-encryption-cert
              mountPath: /var/configs/saml-encryption-cert
            {{- end }}
            {{- if (.Values.saml).decryptionKeySecret }}
            - name: saml-decryption-key
              mountPath: /var/configs/saml-decryption-key
            {{- end }}
            {{- if (.Values.saml).metadataSecretName }}
            - name: metadata-secret-volume
              mountPath: /var/configs/metadata-secret-volume
            {{- end }}
            - name: saml-auth-secret
              mountPath: /var/configs/saml-auth-secret
            {{- if ((.Values.saml).rbac).enabled }}
            - name: saml-roles
              mountPath: /var/configs/saml
            {{- end }}
            {{- end }}
            {{- if (.Values.oidc).enabled }}
            - name: oidc-config
              mountPath: /var/configs/oidc
            {{- if or ((.Values.oidc).existingCustomSecret).name (.Values.oidc).secretName }}
            - name: oidc-client-secret
              mountPath: /var/configs/oidc-client-secret
            {{- end }}
            {{- end }}
            {{- if eq (include "kubecost.rbacTeams.enabled" .) "true" }}
            - name: kubecost-rbac-secret
              mountPath: /var/configs/kubecost-rbac-secret
            {{- end }}
            {{- if eq (include "kubecost.authMasterKey.enabled" .) "true" }}
            - name: kubecost-master-api-key
              mountPath: /var/configs/auth
            {{- end }}
            {{- if eq (include "kubecost.rbacTeams.config.enabled" .) "true" }}
            - name: kubecost-rbac-teams-config
              mountPath: /var/configs/rbac-teams-configs
            {{- end }}
            {{- if .Values.global.integrations.postgres.enabled }}
            - name: postgres-creds
              mountPath: /var/configs/integrations/postgres-creds
            - name: postgres-queries
              mountPath: /var/configs/integrations/postgres-queries
            {{- end }}
            {{- if .Values.global.updateCaTrust.enabled }}
            - name: ca-certs-secret
              mountPath: {{ .Values.global.updateCaTrust.caCertsMountPath | quote }}
            - name: ssl-path
              mountPath: "/etc/pki/ca-trust/extracted"
              readOnly: false
            {{- end }}
            {{- if (.Values.enterpriseCustomPricing).enabled }}
            - name: kubecost-enterprise-pricing
              mountPath: /var/configs/enterprise-pricing
            {{- end }}
            {{- if ((.Values.kubecostProductConfigs).actions).config }}
            - name: actions-config
              mountPath: /var/configs/actions
            {{- end }}
            {{- if ((.Values.kubecostProductConfigs).actions).enabled }}
            {{- if and (not (((.Values.kubecostProductConfigs).actions).storageConfigSecret)) (not (((.Values.kubecostProductConfigs).actions).storageConfig)) }}
            - name: actions-storage
              mountPath: /var/configs/actions/storage
            - name: federated-storage-config
              mountPath: /var/configs/actions/storage/actions-store.yaml
              subPath: {{ include "kubecost.federatedStorage.fileName" . }}
              readOnly: true
            {{- end }}
            {{- if  ((.Values.kubecostProductConfigs).actions).turndownClusters }}
            - name: kubecost-clusters
              mountPath: /var/configs/clusters
            {{- end }}
            {{- if ((.Values.kubecostProductConfigs).actions).storageConfig }}
            - name: actions-storage-config
              mountPath: /var/configs/actions/storage
            {{- end }}
            {{- if ((.Values.kubecostProductConfigs).actions).storageConfigSecret }}
            {{- if eq ((.Values.kubecostProductConfigs).actions).storageConfigSecret .Values.global.federatedStorage.existingSecret  }}
            - name: actions-storage
              mountPath: /var/configs/actions/storage
            - name: federated-storage-config
              mountPath: /var/configs/actions/storage/actions-store.yaml
              subPath: {{ include "kubecost.federatedStorage.fileName" . }}
              readOnly: true
            {{- else }}
            - name: actions-storage-config
              mountPath: /var/configs/actions/storage
            {{- end }}
            {{- end }}
            {{- end }}
            {{- if .Values.aggregator.extraVolumeMounts }}
            {{- toYaml .Values.aggregator.extraVolumeMounts | nindent 12 }}
            {{- end }}
            {{- if .Values.global.integrations.turbonomic.enabled }}
            - name: turbonomic-credentials
              mountPath: /var/configs/turbonomic
            {{- end }}
          env:
            - name: CLUSTER_ID
              value: {{ include "kubecost.clusterId" . }}
            - name: INSTALL_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            {{- if ((.Values.kubecostProductConfigs).productKey).mountPath }}
            - name: PRODUCT_KEY_MOUNT_PATH
              value: {{ .Values.kubecostProductConfigs.productKey.mountPath }}
            {{- end }}
            {{- if ((.Values.kubecostProductConfigs).smtp).mountPath }}
            - name: SMTP_CONFIG_MOUNT_PATH
              value: {{ .Values.kubecostProductConfigs.smtp.mountPath }}
            {{- end }}
            {{- if .Values.smtpConfigmapName }}
            - name: SMTP_CONFIGMAP_NAME
              value: {{ .Values.smtpConfigmapName }}
            {{- end }}
            {{- if (gt (int .Values.aggregator.numDBCopyPartitions) 0) }}
            - name: NUM_DB_COPY_CHUNKS
              value: {{ .Values.aggregator.numDBCopyPartitions | quote }}
            {{- end }}
            {{- if .Values.aggregator.legacyMode }}
            - name: LEGACY_MODE
              value: "true"
            {{- end }}
            {{- if .Values.aggregator.jaeger.enabled }}
            - name: TRACING_URL
              value: "http://localhost:14268/api/traces"
            {{- end }}
            - name: CONFIG_PATH
              value: /var/configs/
            - name: CLOUD_PROVIDER_API_KEY
              value: "AIzaSyDXQPG_MHUEy9neR7stolq6l0ujXmjJlvk" # The GCP Pricing API key.This GCP api key is expected to be here and is limited to accessing google's billing API.'
            {{- if .Values.global.integrations.postgres.enabled }}
            - name: AGGREGATOR_ADDRESS
            {{- if or .Values.saml.enabled .Values.oidc.enabled }}
              value: localhost:9008
            {{- else }}
              value: localhost:9004
            {{- end }}
            - name: INT_PG_ENABLED
              value: "true"
            - name: INT_PG_RUN_INTERVAL
              value: {{ quote .Values.global.integrations.postgres.runInterval }}
            {{- end }}
            - name: READ_ONLY
              value: {{ (quote .Values.readonly) | default (quote false) }}
            {{- include "common.systemProxy" . | nindent 12 }}
            {{- if ((.Values.kubecostProductConfigs).carbonEstimates) }}
            - name: CARBON_ESTIMATES_ENABLED
              value: "true"
            {{- end }}
            - name: CUSTOM_COST_ENABLED
              value: {{ .Values.plugins.enabled | quote }}
            {{- if .Values.diagnostics.enabled }}
            - name: DIAGNOSTICS_ENABLED
              value: "true"
            - name: DIAGNOSTICS_RETENTION
              value: {{ .Values.diagnostics.retention | quote }}
            {{- end }}
            {{- if .Values.heartbeat.enabled }}
            - name: HEARTBEAT_ENABLED
              value: "true"
            - name: HEARTBEAT_RETENTION
              value: {{ .Values.heartbeat.retention | quote }}
            {{- end }}
            {{- if (.Values.aggregator).standardDiscount }}
            {{- if .Values.ingestionConfigmapName }}
            - name: INGESTION_CONFIGMAP_NAME
              value: {{ .Values.ingestionConfigmapName }}
            {{- end }}
            {{- end }}
            - name: LOG_LEVEL
              value: {{ .Values.aggregator.logLevel }}
            - name: DB_READ_THREADS
              value: {{ .Values.aggregator.dbReadThreads | quote }}
            - name: DB_WRITE_THREADS
              value: {{ .Values.aggregator.dbWriteThreads | quote }}
            - name: DB_CONCURRENT_INGESTION_COUNT
              value: {{ .Values.aggregator.dbConcurrentIngestionCount | quote }}
            {{- if ne .Values.aggregator.dbMemoryLimit "0GB" }}
            - name: DB_MEMORY_LIMIT
              value: {{ .Values.aggregator.dbMemoryLimit | quote }}
            {{- end }}
            {{- if ne .Values.aggregator.dbWriteMemoryLimit "0GB" }}
            - name: DB_WRITE_MEMORY_LIMIT
              value: {{ .Values.aggregator.dbWriteMemoryLimit | quote }}
            {{- end }}
            - name: RESOLUTION_1D_RETENTION
              value: {{ .Values.aggregator.retention1d | quote }}
            - name: RESOLUTION_1H_RETENTION
              value: {{ .Values.aggregator.retention1h | quote }}
            - name: RESOLUTION_10M_RETENTION
              value: {{ .Values.aggregator.retention10m | quote }}
            - name: CONTAINER_RESOURCE_USAGE_RETENTION_DAYS
              value: {{ .Values.aggregator.containerResourceUsageRetentionDays | quote }}
            - name: DB_TRIM_MEMORY_ON_CLOSE
              value: {{ .Values.aggregator.dbTrimMemoryOnClose | quote }}
            - name: KUBECOST_NAMESPACE
              value: {{ .Release.Namespace }}
            - name: TELEMETRY_ENABLED
              value: {{ (quote .Values.telemetry.enabled) }}
            {{- if .Values.oidc.enabled }}
            - name: OIDC_ENABLED
              value: "true"
            - name: OIDC_SKIP_ONLINE_VALIDATION
              value: {{ (quote .Values.oidc.skipOnlineTokenValidation) | default (quote false) }}
            {{- end}}
            {{- if eq (include "kubecost.rbacTeams.enabled" .) "true" }}
            {{- if .Values.oidc.enabled }}
            - name: OIDC_RBAC_TEAMS_ENABLED
              value: "true"
            {{- end }}
            {{- if .Values.saml.enabled }}
            - name: SAML_RBAC_TEAMS_ENABLED
              value: "true"
            {{- end }}
            {{- end }}
            {{- if eq (include "kubecost.authMasterKey.enabled" .) "true" }}
            - name: AUTH_MASTER_API_KEY_ENABLED
              value: "true"
            {{- end }}
            {{- if eq (include "kubecost.rbacTeams.config.enabled" .) "true" }}
            - name: RBAC_TEAMS_HELM_CONFIG_PATH
              value: "/var/configs/rbac-teams-configs/rbac-teams-configs.json"
            {{- end }}
            - name: COLLECTIONS_MEMORY_CACHE_ENABLED
              value: {{ (quote .Values.aggregator.collections.cache.enabled) }}
            {{- if ((.Values.global.integrations).turbonomic).enabled }}
            - name: TURBONOMIC_ENABLED
              value: "true"
            {{- end }}
            {{- if (.Values.saml).enabled }}
            - name: SAML_ENABLED
              value: "true"
            - name: IDP_URL
              value: {{ .Values.saml.idpMetadataURL }}
            - name: SP_HOST
              value: {{ .Values.saml.appRootURL }}
            {{- if .Values.saml.audienceURI }}
            - name: AUDIENCE_URI
              value: {{ .Values.saml.audienceURI }}
            {{- end }}
            {{- if .Values.saml.isGLUUProvider }}
            - name: GLUU_SAML_PROVIDER
              value: {{ (quote .Values.saml.isGLUUProvider) }}
            {{- end }}
            {{- if .Values.saml.nameIDFormat }}
            - name: NAME_ID_FORMAT
              value: {{ .Values.saml.nameIDFormat }}
            {{- end}}
            {{- if .Values.saml.authTimeout }}
            - name: AUTH_TOKEN_TIMEOUT
              value: {{ (quote .Values.saml.authTimeout) }}
            {{- end}}
            {{- if .Values.saml.redirectURL }}
            - name: LOGOUT_REDIRECT_URL
              value: {{ .Values.saml.redirectURL }}
            {{- end}}
            {{- if .Values.saml.rbac.enabled }}
            {{- if eq (include "kubecost.rbacTeams.enabled" .) "false" }}
            - name: SAML_RBAC_ENABLED
              value: "true"
            {{- end }}
            {{- end }}
            {{- if and .Values.saml.encryptionCertSecret .Values.saml.decryptionKeySecret }}
            - name: SAML_RESPONSE_ENCRYPTED
              value: "true"
            {{- end}}
            {{- end }}
            {{- if (.Values.enterpriseCustomPricing).enabled }}
            - name: ENTERPRISE_CUSTOM_PRICING_ENABLED
              value: "true"
            - name: ENTERPRISE_CUSTOM_PRICING_CSV_LOCATION_URI
              value: {{ (quote .Values.enterpriseCustomPricing.location.URI) }}
            - name: ENTERPRISE_CUSTOM_PRICING_APPLY_RETROACTIVELY
              value: "true"
            {{- end }}
            {{- if ((.Values.kubecostProductConfigs).actions).enabled }}
            - name: ACTIONS_ENABLED
              value: "true"
            - name: ACTIONS_BUCKET_CONFIG
              value: /var/configs/actions/storage/actions-store.yaml
            {{- end }}
            {{- if (.Values.kubecostProductConfigs).currencyCode }}
            - name: DISPLAY_CURRENCY
              value: {{ (.Values.kubecostProductConfigs).currencyCode }}
            {{- end }}
            {{- if .Values.deploymentGuide.enabled }}
            - name: ENABLE_DEPLOYMENT_GUIDE
              value: "true"
            {{- end }}
            {{- if .Values.aggregator.extraEnv -}}
            {{- toYaml .Values.aggregator.extraEnv | nindent 12 }}
            {{- end }}
        {{- if .Values.aggregator.jaeger.enabled }}
        - name: embedded-jaeger
          env:
            - name: SPAN_STORAGE_TYPE
              value: badger
            - name: BADGER_EPHEMERAL
              value: "true"
            - name: BADGER_DIRECTORY_VALUE
              value: /tmp/badger/data
            - name: BADGER_DIRECTORY_KEY
              value: /tmp/badger/key
          securityContext:
            {{- toYaml .Values.aggregator.jaeger.containerSecurityContext | nindent 12 }}
          image: {{ .Values.aggregator.jaeger.image }}:{{ .Values.aggregator.jaeger.imageVersion }}
        {{- end }}
      {{- include "kubecost.imagePullSecrets" . | nindent 6 }}
      {{- if .Values.aggregator.priority }}
      {{- if .Values.aggregator.priority.enabled }}
      {{- if .Values.aggregator.priority.name }}
      priorityClassName: {{ .Values.aggregator.priority.name }}
      {{- else }}
      priorityClassName: {{ template "kubecost.fullname" . }}-aggregator-priority
      {{- end }}
      {{- end }}
      {{- end }}
      {{- with .Values.aggregator.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 16 }}
      {{- end }}
      {{- with .Values.aggregator.tolerations }}
      tolerations:
        {{- toYaml . | nindent 16 }}
      {{- end }}
      {{- with .Values.aggregator.affinity }}
      affinity:
        {{- toYaml . | nindent 16 }}
{{- end }}
{{- end }}
